rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Users: can read/write only own document
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;

      // Tasks subcollection: same auth rule
      match /tasks/{taskId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // Parties: authenticated users can read (needed for invite code query)
    // Only members can write
    match /parties/{partyId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null
        && (request.auth.uid in resource.data.memberIds
            || request.resource.data.memberIds.hasAny([request.auth.uid]));
      allow delete: if request.auth != null
        && request.auth.uid == resource.data.leaderId;
    }
  }
}
